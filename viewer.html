<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <style type="text/css">
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #map {
                height: 100%;
            }

        </style>
    </head>
    <body>
        <div id="map"></div>

        <script type="text/javascript">
var map;
var infowindow;
var points = [];
var markers = [];

var colors = ['blue','brown','darkgreen','green','orange','paleblue','pink',
              'purple','red','yellow'];
var colorPos = [];

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: -34.639405, lng:-58.545210},
        zoom: 9
    });

    infowindow = new google.maps.InfoWindow();

    if(points.length > 0) {
        showPoints();
    }
}

function getPoints() {
    var r = new XMLHttpRequest();
    r.open("GET", "data.json", true);
    r.onreadystatechange = function () {
        if (r.readyState != 4 || r.status != 200) {
            console.log("Couldn't load the data :/");
            return;
        }
        points = JSON.parse(r.responseText);
        showPoints();
    };
    r.send();
}

function showPoints() {
    if(typeof map == "undefined") return;

    // Delete the old markers
    for(var i=0; i<markers.length; i++) {
        google.maps.event.removeListener(markers[i].listener);
        markers[i].setMap(null);
        colorPos = [];
    }
    markers = [];

    // Add a marker for every point
    for(var i=0; i<points.length; i++) {
        var point = points[i];

        var marker = new google.maps.Marker({
            position: {lat: point.lat, lng: point.lng},
            map: map,
            title: point.name
        });

        if(point.encuestador) {
            var letter = point.encuestador[0].toUpperCase();
            var color = colors[0];
            var index = colorPos.indexOf(point.encuestador);
            if(index < 0) {
                index = colorPos.push(point.encuestador) - 1;
            }
            color = colors[index % colors.length];

            marker.setIcon("markers/"+color+"_Marker"+letter+".png");
        }

        // Show an info window on click
        // (we need a function factory to conserve the reference)
        marker.listener = marker.addListener('click',function(mark,point){
            return function(){
                infowindow.close();
                infowindow.setContent(
                    point.name + "</br></br>" +
                    point.address + "</br>" +
                    "Codigo postal: " + point['codigo postal'] + "</br>" +
                    "</br>" +
                    (point.encuestador ? "Encuestador: " + point.encuestador + "</br></br>" : "")+
                    "CODEM: " + point.CODEM + "</br>" +
                    "Numero de socio: " + point.socio + "</br>" +
                    "email: " + point.email + "</br>" +
                    "telefono: " + point.telefono + "</br>" +
                    (point.telefono2 ? "telefono 2: " + point.telefono2 + "</br>" : "")
                    );
                infowindow.open(map,mark);
            }
        }(marker,points[i]));

        markers.push(marker);
    }
}

getPoints();

        </script>
        <!-- This api key is set set to a specific url, so don't try to use it :) --!>
        <script async defer
              src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAcyGFLnwgl_YmqFiaCo2ovMAQlB9G1gg8&callback=initMap">
        </script>
    </body>
</html>
